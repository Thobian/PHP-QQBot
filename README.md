#webqq robot

###
特别感谢
https://github.com/ScienJus/qqbot

想做一个自动抓图的东西发到qq群里面，之前一直懒得做，<span style="background-color: transparent;">前几天偶然在Github上看到了这样一个</span><span style="background-color: transparent;">轮子</span><span style="background-color: transparent;">，看起来好像不麻烦，于是决定自己也写一个。</span>

可能有人会问我为什么明明有现成的轮子了还要自己写一个，原因很简单：因为PHP没有。

但是写到一半我才发现Web QQ在某个版本将收发图片的功能移除了，所以初衷还是无法实现。

### 对Web QQ协议的一些看法

1.  整个鉴权模块Cookie、Session、Token全都用上了，真是折腾人
2.  加密函数压缩混淆后放在JS还是会被找出来，不过只要偶尔换换也很折腾人
3.  整个登录流程分了5步，偶尔加一步、减一步或者改一步同样折腾人（我在写这个项目的时候，正好登录流程就变了，当时还顺便给刚才提到的轮子的作者发了封邮件告诉他这个地方改了）
4.  返回数据只提供了返回码而没有描述，因为什么失败了自己猜去吧
5.  大部分请求都同时检查了Cookie、Referer、User-Agent和Origin（只有Post请求有）
6.  对一些不合理的情况进行了判断，比如登录后却没有发起接收消息的请求
7.  对访问频率进行了控制，太频繁的请求也会被拒绝

综上所述，作为一个Web应用，想要不被开发者抓包并模拟请求是很难的。你唯一能做的就是去尽量的恶心他们。并且利用Web项目迭代方便的特性，频繁的进行鉴权等模块的修改，淘汰掉那些开发者没有足够精力维护的项目。

### 写本文的目的

接下来我将介绍一下当前（2015年12月）版本的Web QQ协议，数据来源基本上都是通过Chrome控制台对[Smart QQ](http://w.qq.com/)进行抓包得到的，如果你也想自己实现一个这样的轮子，这些资料可以避免你走很多弯路。

不过在此之前先说一些公共约定：

1.  保证请求头中包含正常的`User-Agent`、`Referer`、`Cookie`等信息，如果是`Post`请求需要额外加上`Origin`
2.  在大部分情况下（除了获取二维码和确认二维码状态），返回内容均为JSON，其中`retcode`为请求结果（`0`为成功），`response`为返回数据
3.  不过还有个特例是发送消息的接口，成功时返回的字段是`errCode`，失败时才是`retcode`
4.  请求失败后，返回的错误码如果是`1000000`或`1000001`，几乎可以认为是缺少了第一条中的某个数据
5.  如果请求参数中有`t`，当前版本不会检验它的值，所以我统一设为`0.1`，但是实际上它的值一般情况下均为当前时间的`unix timestamp`
6.  如果返回的返回的错误码为`1000003`，很有可能是你的请求频率过于频繁

了解了以上信息后，便可以开始愉快地写接口了